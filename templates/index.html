<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Autologin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00ff41;
            font-size: 2.5rem;
            text-shadow: 0 0 10px #00ff41;
        }

        .control-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .process-card {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }

        .process-card:hover {
            transform: translateY(-2px);
        }

        .process-title {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .status-running {
            background-color: #00ff41;
            box-shadow: 0 0 8px #00ff41;
        }

        .status-stopped {
            background-color: #ff4757;
            box-shadow: 0 0 8px #ff4757;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }

        .btn-start {
            background-color: #2ed573;
            color: white;
        }

        .btn-start:hover {
            background-color: #20bf6b;
            transform: scale(1.05);
        }

        .btn-stop {
            background-color: #ff4757;
            color: white;
        }

        .btn-stop:hover {
            background-color: #ff3742;
            transform: scale(1.05);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .workers-input {
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #3d3d3d;
            color: white;
            width: 80px;
        }

        .workers-label {
            font-size: 14px;
            color: #ccc;
        }

        .logs-section {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .logs-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .logs-title {
            font-size: 1.5rem;
            color: #00ff41;
        }

        .clear-logs-btn {
            background-color: #747d8c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .clear-logs-btn:hover {
            background-color: #57606f;
        }

        .logs-container {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 2px;
            word-wrap: break-word;
        }

        .log-manager {
            color: #ffa502;
        }

        .log-api-server {
            color: #3742fa;
        }

        .log-autologin {
            color: #2ed573;
        }

        .status-bar {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .connection-status {
            display: flex;
            align-items: center;
        }

        .ws-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .ws-connected {
            background-color: #2ed573;
        }

        .ws-disconnected {
            background-color: #ff4757;
        }

        .timestamp {
            color: #747d8c;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
        }

        .loading {
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Panel de Control - Autologin</h1>
        
        <!-- Panel de Control de Procesos -->
        <div class="control-panel">
            <!-- API Server -->
            <div class="process-card">
                <div class="process-title">
                    <div id="api-status" class="status-indicator status-stopped"></div>
                    API Server
                </div>
                <div class="controls">
                    <button id="start-api" class="btn btn-start">Iniciar API Server</button>
                    <button id="stop-api" class="btn btn-stop">Detener API Server</button>
                </div>
                <div style="font-size: 12px; color: #aaa; margin-top: 10px;">
                    Servidor de resolución de captchas en puerto 8080
                </div>
            </div>

            <!-- Autologin -->
            <div class="process-card">
                <div class="process-title">
                    <div id="autologin-status" class="status-indicator status-stopped"></div>
                    Autologin
                </div>
                <div class="controls">
                    <label class="workers-label">Workers:</label>
                    <input id="workers-count" type="number" class="workers-input" value="10" min="1" max="50">
                    <button id="start-autologin" class="btn btn-start">Iniciar Autologin</button>
                    <button id="stop-autologin" class="btn btn-stop">Detener Autologin</button>
                </div>
                <div style="font-size: 12px; color: #aaa; margin-top: 10px;">
                    Procesamiento concurrente de cuentas
                </div>
            </div>
        </div>

        <!-- Sección de Logs en Tiempo Real -->
        <div class="logs-section">
            <div class="logs-header">
                <h2 class="logs-title">Logs en Tiempo Real</h2>
                <button id="clear-logs" class="clear-logs-btn">Limpiar Logs</button>
            </div>
            <div id="logs-container" class="logs-container">
                <div class="log-entry log-manager">[MANAGER] Panel de control iniciado</div>
            </div>
        </div>

        <!-- Barra de Estado -->
        <div class="status-bar">
            <div class="connection-status">
                <div id="ws-indicator" class="ws-indicator ws-disconnected"></div>
                <span id="ws-status">Conectando...</span>
            </div>
            <div class="timestamp" id="last-update">
                Última actualización: --:--:--
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let websocket = null;
        let reconnectInterval = null;
        let statusUpdateInterval = null;

        // Elementos DOM
        const elements = {
            // Indicadores de estado
            apiStatus: document.getElementById('api-status'),
            autologinStatus: document.getElementById('autologin-status'),
            wsIndicator: document.getElementById('ws-indicator'),
            wsStatus: document.getElementById('ws-status'),
            lastUpdate: document.getElementById('last-update'),
            
            // Botones
            startApi: document.getElementById('start-api'),
            stopApi: document.getElementById('stop-api'),
            startAutologin: document.getElementById('start-autologin'),
            stopAutologin: document.getElementById('stop-autologin'),
            clearLogs: document.getElementById('clear-logs'),
            
            // Inputs
            workersCount: document.getElementById('workers-count'),
            
            // Contenedores
            logsContainer: document.getElementById('logs-container')
        };

        // Funciones de utilidad
        function updateTimestamp() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-ES');
            elements.lastUpdate.textContent = `Última actualización: ${timeStr}`;
        }

        function addLogEntry(message, type = 'manager') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type.toLowerCase().replace('_', '-')}`;
            
            const timestamp = new Date().toLocaleTimeString('es-ES');
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            elements.logsContainer.appendChild(logEntry);
            
            // Auto-scroll hacia abajo
            elements.logsContainer.scrollTop = elements.logsContainer.scrollHeight;
            
            // Limitar número de logs (mantener solo los últimos 500)
            const logs = elements.logsContainer.children;
            if (logs.length > 500) {
                elements.logsContainer.removeChild(logs[0]);
            }
        }

        function updateProcessStatus(processName, status) {
            const statusElement = processName === 'api_server' ? elements.apiStatus : elements.autologinStatus;
            
            statusElement.classList.remove('status-running', 'status-stopped');
            statusElement.classList.add(status === 'running' ? 'status-running' : 'status-stopped');
        }

        function setButtonsLoading(processName, isLoading) {
            const buttons = processName === 'api_server' 
                ? [elements.startApi, elements.stopApi]
                : [elements.startAutologin, elements.stopAutologin];
            
            buttons.forEach(btn => {
                btn.disabled = isLoading;
                btn.classList.toggle('loading', isLoading);
            });
        }

        // Funciones de API
        async function startProcess(processName, workers = null) {
            setButtonsLoading(processName, true);
            
            try {
                const url = workers !== null 
                    ? `/start/${processName}?workers=${workers}`
                    : `/start/${processName}`;
                
                const response = await fetch(url, { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    addLogEntry(`✓ ${data.message}`, 'manager');
                } else {
                    addLogEntry(`✗ Error: ${data.detail}`, 'manager');
                }
            } catch (error) {
                addLogEntry(`✗ Error de red: ${error.message}`, 'manager');
            } finally {
                setButtonsLoading(processName, false);
                updateStatus(); // Actualizar estado inmediatamente
            }
        }

        async function stopProcess(processName) {
            setButtonsLoading(processName, true);
            
            try {
                const response = await fetch(`/stop/${processName}`, { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    addLogEntry(`✓ ${data.message}`, 'manager');
                } else {
                    addLogEntry(`✗ Error: ${data.detail}`, 'manager');
                }
            } catch (error) {
                addLogEntry(`✗ Error de red: ${error.message}`, 'manager');
            } finally {
                setButtonsLoading(processName, false);
                updateStatus(); // Actualizar estado inmediatamente
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                // Actualizar indicadores de estado
                updateProcessStatus('api_server', data.processes.api_server);
                updateProcessStatus('autologin', data.processes.autologin);
                
                updateTimestamp();
            } catch (error) {
                console.error('Error actualizando estado:', error);
                addLogEntry(`⚠ Error actualizando estado: ${error.message}`, 'manager');
            }
        }

        // Funciones WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    console.log('WebSocket conectado');
                    elements.wsIndicator.className = 'ws-indicator ws-connected';
                    elements.wsStatus.textContent = 'Conectado';
                    addLogEntry('✓ Conexión WebSocket establecida', 'manager');
                    
                    // Limpiar intervalo de reconexión si existe
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                };
                
                websocket.onmessage = function(event) {
                    const message = event.data;
                    
                    if (message === 'ping') {
                        // Responder al ping del servidor
                        websocket.send('pong');
                        return;
                    }
                    
                    // Determinar el tipo de log basado en el prefijo
                    let logType = 'manager';
                    if (message.includes('[API_SERVER]')) {
                        logType = 'api_server';
                    } else if (message.includes('[AUTOLOGIN]')) {
                        logType = 'autologin';
                    }
                    
                    addLogEntry(message, logType);
                };
                
                websocket.onclose = function(event) {
                    console.log('WebSocket desconectado:', event.code, event.reason);
                    elements.wsIndicator.className = 'ws-indicator ws-disconnected';
                    elements.wsStatus.textContent = 'Desconectado';
                    addLogEntry('⚠ Conexión WebSocket perdida - Reintentando...', 'manager');
                    
                    // Intentar reconectar cada 5 segundos
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(connectWebSocket, 5000);
                    }
                };
                
                websocket.onerror = function(error) {
                    console.error('Error WebSocket:', error);
                    addLogEntry('✗ Error en conexión WebSocket', 'manager');
                };
                
            } catch (error) {
                console.error('Error creando WebSocket:', error);
                addLogEntry(`✗ Error creando WebSocket: ${error.message}`, 'manager');
                
                // Intentar reconectar
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            }
        }

        // Event Listeners
        elements.startApi.addEventListener('click', () => startProcess('api_server'));
        elements.stopApi.addEventListener('click', () => stopProcess('api_server'));
        
        elements.startAutologin.addEventListener('click', () => {
            const workers = parseInt(elements.workersCount.value) || 10;
            startProcess('autologin', workers);
        });
        elements.stopAutologin.addEventListener('click', () => stopProcess('autologin'));
        
        elements.clearLogs.addEventListener('click', () => {
            elements.logsContainer.innerHTML = '';
            addLogEntry('Logs limpiados', 'manager');
        });

        // Validación del input de workers
        elements.workersCount.addEventListener('input', function() {
            const value = parseInt(this.value);
            if (value < 1) this.value = 1;
            if (value > 50) this.value = 50;
        });

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('🚀 Panel de control cargado', 'manager');
            
            // Conectar WebSocket
            connectWebSocket();
            
            // Actualizar estado inicial
            updateStatus();
            
            // Configurar actualización periódica del estado cada 2 segundos
            statusUpdateInterval = setInterval(updateStatus, 2000);
            
            // Actualizar timestamp cada segundo
            setInterval(updateTimestamp, 1000);
        });

        // Limpiar intervalos al cerrar la página
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
            }
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
        });
    </script>
</body>
</html>
